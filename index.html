<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alien Checkpoint</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f1626; --ink:#e6f0ff; --muted:#9ab; --accent:#66e; --warn:#ffbe0b; --bad:#ef4444; --good:#22c55e; --paper:#f7f4e8; --inkpaper:#1e293b; --border:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0a0d17 60%);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#0e1422;border:1px solid var(--border);border-radius:14px;position:sticky;top:0;z-index:10;backdrop-filter:blur(6px)}
  header h1{font-size:18px;margin:0 8px 0 0;letter-spacing:.6px}
  .stat{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#0b1220;border:1px solid var(--border);border-radius:10px}
  .stat b{font-weight:700}
  .grow{flex:1}
  .btn{appearance:none;border:1px solid var(--border);background:#121a2b;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;transition:transform .05s ease,background .2s}
  .btn:hover{background:#141f34}
  .btn:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:360px 1fr 360px;gap:14px;margin-top:14px}
  .panel{background:#0f1626;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .panel h2{margin:0;padding:10px 12px;background:#0c1220;border-bottom:1px solid var(--border);font-size:14px;color:#cde;text-transform:uppercase;letter-spacing:.7px}
  .pad{padding:12px}
  .queue{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
  .alienCard{display:flex;gap:10px;align-items:center;padding:10px;background:#10192d;border:1px dashed #233355;border-radius:12px}
  .alienPic{width:54px;height:54px;border-radius:10px;background:#091225;display:grid;place-items:center;overflow:hidden}
  .alienMeta{font-size:12px;color:var(--muted)}
  .workspace{display:grid;grid-template-columns:1fr;gap:10px}
  .desk{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .doc{background:var(--paper);color:var(--inkpaper);border:2px solid #c9c4b4;border-radius:10px;box-shadow:0 1px 0 #0004 inset, 0 8px 30px #0005;padding:10px;position:relative;min-height:160px}
  .doc h3{margin:0 0 6px;font:700 14px ui-monospace,Consolas,monospace;letter-spacing:.4px}
  .doc table{width:100%;border-collapse:collapse;font:13px ui-monospace,Consolas,monospace}
  .doc td{padding:4px 6px;border-bottom:1px dashed #d7d2c2}
  .doc td:first-child{width:44%}
  .stamp{position:absolute;inset:auto auto 10px 10px;padding:6px 10px;border:3px solid #b33;border-radius:8px;color:#b33;font:700 16px ui-monospace,Consolas,monospace;transform:rotate(-6deg);opacity:0;pointer-events:none}
  .stamp.ok{border-color:#1d7c3a;color:#1d7c3a}
  .tools{display:flex;gap:10px}
  .hammer{background:#0d172a;border:1px solid var(--border);border-radius:12px;padding:10px}
  .big{display:flex;gap:10px}
  .big .btn{font-size:16px;padding:12px 14px}
  .rule{padding:10px;border-bottom:1px dashed #2a3b6b}
  .rule:last-child{border-bottom:none}
  .rule b{color:#cfe1ff}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:10px;align-items:center}
  .money{color:#86efac}
  .strike{color:#fecaca}
  .log{max-height:180px;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:8px;font:12px ui-monospace,Consolas,monospace}
  .log p{margin:0 0 6px}
  .switches{display:flex;gap:8px;flex-wrap:wrap}
  .chip{font:12px ui-monospace,Consolas,monospace;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0c1322}
  .right{display:flex;flex-direction:column;gap:10px}
  .footer{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted)}
  .kbd{font:600 12px ui-monospace,Consolas,monospace;background:#0c1322;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f1626;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px #0007;display:none}
  .rank{font-weight:700}
  .progress{height:8px;background:#12203a;border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2dd4bf,#60a5fa)}
  .help{font-size:13px;color:#cbd5e1}
  .disclaimer{font-size:12px;color:#8ea3c7}
  .photo{display:grid;grid-template-columns:72px 1fr;gap:8px;align-items:center}
  .photo img{width:72px;height:72px;border-radius:8px;border:2px solid #c9c4b4;background:white}
  .faceRow{display:flex;gap:6px;flex-wrap:wrap;font:12px ui-monospace,Consolas,monospace}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Alien Checkpoint</h1>
      <div class="stat"><b>Day:</b> <span id="ui-day">1</span></div>
      <div class="stat"><b>Credits:</b> <span id="ui-credits" class="money">0</span></div>
      <div class="stat"><b>Strikes:</b> <span id="ui-strikes" class="strike">0</span></div>
      <div class="stat"><b>Rank:</b> <span id="ui-rank" class="rank">Recruit</span></div>
      <div class="grow"></div>
      <button class="btn" id="btn-newday" title="Start/End Day (Space)">Start Day</button>
      <button class="btn" id="btn-reset" title="Reset save">Reset</button>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>Docking Queue</h2>
        <div class="pad queue" id="queue"></div>
      </section>

      <section class="panel workspace">
        <h2>Inspection Desk</h2>
        <div class="pad desk">
          <div class="doc" id="passport">
            <h3>INTERSTELLAR PASSPORT</h3>
            <div class="photo" style="margin-bottom:6px">
              <img id="pp-live" alt="Live portrait" />
              <div class="faceRow" id="pp-feats">—</div>
            </div>
            <table>
              <tr><td>Species</td><td id="pp-species">—</td></tr>
              <tr><td>Name</td><td id="pp-name">—</td></tr>
              <tr><td>Planet of Origin</td><td id="pp-planet">—</td></tr>
              <tr><td>Birth Cycle</td><td id="pp-dob">—</td></tr>
              <tr><td>Expires</td><td id="pp-exp">—</td></tr>
              <tr><td>Genetic Key</td><td id="pp-gk">—</td></tr>
            </table>
            <div class="stamp" id="pp-stamp">DENIED</div>
          </div>
          <div class="doc" id="visa">
            <h3>DOCKING VISA</h3>
            <table>
              <tr><td>Purpose</td><td id="vs-purpose">—</td></tr>
              <tr><td>Duration</td><td id="vs-duration">—</td></tr>
              <tr><td>Planet Permit</td><td id="vs-planet">—</td></tr>
              <tr><td>Quarantine</td><td id="vs-quar">—</td></tr>
              <tr><td>Seal Code</td><td id="vs-seal">—</td></tr>
            </table>
            <div class="stamp ok" id="vs-stamp">APPROVED</div>
          </div>
          <div class="doc" id="photoid">
            <h3>PHOTO IDENTIFICATION</h3>
            <div class="photo">
              <img id="pid-photo" alt="Recorded photo" />
              <div>
                <div id="pid-caption" class="muted">—</div>
                <div class="faceRow" id="pid-feats">—</div>
              </div>
            </div>
            <div class="stamp" id="pid-stamp">MISMATCH</div>
          </div>
        </div>
        <div class="pad">
          <div class="tools big">
            <button class="btn" id="approve">APPROVE (A)</button>
            <button class="btn" id="deny">DENY (D)</button>
            <button class="btn" id="detain">DETAIN (F)</button>
            <button class="btn" id="next">NEXT SHIP (N)</button>
          </div>
          <div class="footer">
            <div class="switches">
              <span class="chip">Tip: Click a doc to reveal hidden stamps if forged</span>
              <span class="chip">Shortcuts: <span class="kbd">A</span>/<span class="kbd">D</span>/<span class="kbd">F</span>/<span class="kbd">N</span>, <span class="kbd">Space</span> for Start/End Day</span>
            </div>
          </div>
        </div>
        <div class="pad">
          <div class="log" id="log"></div>
        </div>
      </section>

      <section class="panel right">
        <h2>Regulations & Progress</h2>
        <div class="pad" id="rules"></div>
        <div class="pad">
          <div class="help">New: Aliens now have unique randomized anatomy & faces. Ensure the Photo ID matches the live portrait and listed features (arms, eyes, antennae, head shape, markings, color).</div>
        </div>
        <div class="pad">
          <div>Progress to next rank</div>
          <div class="progress"><i id="xpbar"></i></div>
          <div class="disclaimer" style="margin-top:8px">Inspired by border-control puzzle games. Original parody mechanics—no copyrighted assets.</div>
        </div>
      </section>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(function(){
  // --- Game State ---
  const SAVE_KEY = 'alien_checkpoint_save_v3';
  const RANKS = [
    {name:'Recruit', xp:0},
    {name:'Officer', xp:120},
    {name:'Inspector', xp:300},
    {name:'Controller', xp:600},
    {name:'Adjudicator', xp:1000}
  ];

  let state = {
    day: 1,
    credits: 0,
    strikes: 0,
    xp: 0,
    unlocked: {hardMode:false, endless:false},
    inDay:false,
    queue:[],
    current:null,
    seed: Math.floor(Math.random()*1e9)
  };

  // --- Utilities ---
  function rand(){ // Mulberry32 PRNG for reproducibility within a day
    let t = state.seed += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
  const pick = arr => arr[Math.floor(rand()*arr.length)];
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const byId = id=>document.getElementById(id);
  const log = (msg)=>{ const el=byId('log'); const p=document.createElement('p'); p.textContent=msg; el.prepend(p); };
  const toast=(m)=>{const t=byId('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1500)}
  function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify({
      day:state.day, credits:state.credits, strikes:0, xp:state.xp, unlocked:state.unlocked
  })); }
  function load(){ try{ const s=JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); if(s){
      state.day=s.day; state.credits=s.credits; state.strikes=0; state.xp=s.xp||0; state.unlocked=s.unlocked||{hardMode:false,endless:false};
    }}catch(e){console.warn('no save');}
  }

  // --- Content Generation ---
  const SPECIES = [
    {name:'Zerulon', planets:['Aurex','Klyntar']},
    {name:'Myridian', planets:['Doros','Myra-2']},
    {name:'Vorx', planets:['Hask','Vortex-9']},
    {name:'Eldari', planets:['Solace','Nyelle']},
    {name:'Gubb', planets:['Pudra']}
  ];
  const PURPOSES = ['Transit','Trade','Tourism','Work','Diplomacy'];
  const DURATIONS = ['1 day','3 days','7 days','14 days','30 days'];

  const HEADS = ['round','tall','wide','tri'];
  const MARKINGS = ['none','stripes','spots','chevrons'];

  function pad(n){return String(n).padStart(2,'0')}
  function formatDate(dayOffset){
    const y=2481, m= ( (state.day+dayOffset) % 12 ) + 1, d=((state.day*3+dayOffset)%27)+1;
    return `${y}-${pad(m)}-${pad(d)}`
  }

  function makeFeatures(){
    const eyes = 1 + Math.floor(rand()*5); // 1–5
    const arms = 2 + Math.floor(rand()*4); // 2–5
    const antennae = Math.floor(rand()*3); // 0–2
    const head = pick(HEADS);
    const tint = `hsl(${Math.floor(rand()*360)} 70% 65%)`;
    const markings = pick(MARKINGS);
    return {eyes, arms, antennae, head, tint, markings};
  }

  function renderAlienSVG(f){
    // simple vector avatar using features
    const w=72, h=72; const cx=36, cy=40; const bodyH=28; const armY=44;
    const headPath = {
      round:`M18,18 a18,18 0 1,0 36,0 a18,18 0 1,0 -36,0`,
      tall:`M24,14 h24 a8,12 0 0,1 8,12 v12 a20,16 0 0,1 -40,0 v-12 a8,12 0 0,1 8,-12 z`,
      wide:`M16,24 h40 a8,10 0 0,1 0,20 h-40 a8,10 0 0,1 0,-20 z`,
      tri:`M36,14 L56,44 H16 Z`
    }[f.head];

    const eyes = Array.from({length:f.eyes}, (_,i)=>{
      const spread = Math.min(12, 4*(f.eyes-1));
      const x = cx - spread/2 + (i*(spread/(Math.max(1,f.eyes-1))));
      return `<circle cx="${x.toFixed(1)}" cy="32" r="3" fill="#111"/>`;
    }).join('');

    const ants = Array.from({length:f.antennae}, (_,i)=>{
      const x = cx + (i - (f.antennae-1)/2)*8;
      return `<path d="M${x},18 q-4,-8 -8,-12" stroke="#333" stroke-width="2" fill="none"/>`;
    }).join('');

    const mark = f.markings==='none'? '' : (
      f.markings==='stripes' ? `<path d="M22,28 h28 M22,36 h28" stroke="#0005" stroke-width="3"/>` :
      f.markings==='spots' ? `<circle cx="26" cy="30" r="2" fill="#0005"/><circle cx="46" cy="36" r="2" fill="#0005"/>` :
      `<path d="M24,34 l12,-8 l12,8" stroke="#0005" stroke-width="3" fill="none"/>`
    );

    const arms = Array.from({length:f.arms}, (_,i)=>{
      const x = 16 + i*(40/(f.arms-1||1));
      return `<rect x="${x-2}" y="${armY}" width="4" height="14" rx="2" fill="#7aa3"/>`;
    }).join('');

    const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'>
      <rect width='${w}' height='${h}' fill='white'/>
      <g>
        <rect x='14' y='42' width='44' height='18' rx='8' fill='${f.tint}'/>
        <path d='${headPath}' fill='${f.tint}' stroke='#0004' stroke-width='1'/>
        ${mark}
        ${ants}
        ${eyes}
        ${arms}
      </g>
    </svg>`;
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }

  function featuresSummary(f){
    return [`eyes:${f.eyes}`,`arms:${f.arms}`,`ant:${f.antennae}`,`head:${f.head}`,`mark:${f.markings}`].join(' | ');
  }

  function maybePhotoMismatch(real){
    const forged = JSON.parse(JSON.stringify(real));
    const knobs = ['eyes','arms','antennae','head','markings'];
    const k = pick(knobs);
    if(k==='eyes') forged.eyes = clamp(real.eyes + (rand()>0.5?1:-1),1,5);
    if(k==='arms') forged.arms = clamp(real.arms + (rand()>0.5?1:-1),2,5);
    if(k==='antennae') forged.antennae = clamp(real.antennae + (rand()>0.5?1:-1),0,2);
    if(k==='head') forged.head = pick(HEADS.filter(h=>h!==real.head));
    if(k==='markings') forged.markings = pick(MARKINGS.filter(m=>m!==real.markings));
    // tiny hue nudge
    return forged;
  }

  function makeAlien(day){
    const sp = pick(SPECIES);
    const name = pick(['Ryll','Kora','Jent','Zux','Mira','Torv','Plek','Lena','Qir','Brol']) + ' ' + pick(['Zeen','Tark','Vel','Qor','Dax','Meln','Iri','Sorn']);
    const planet = pick(sp.planets);
    const dob = `${2440+Math.floor(rand()*40)}-${pad(1+Math.floor(rand()*12))}-${pad(1+Math.floor(rand()*27))}`;
    const expOk = rand()>0.18; // some expired
    const exp = expOk? formatDate( 10 + Math.floor(rand()*30) ) : formatDate( - (1+Math.floor(rand()*8)) );
    const purpose = pick(PURPOSES);
    const duration = pick(DURATIONS);
    const seal = (rand()>0.15)? 'NX-'+(100+Math.floor(rand()*900)) : 'FORGE';
    const gk = (rand()>0.1)? ('GK'+Math.floor(rand()*99999)) : 'MISMATCH';
    const quarant = (rand()>0.8)? 'Required' : 'None';

    const feats = makeFeatures();
    const photoForged = rand()>0.82; // sometimes mismatch photo
    const photoFeats = photoForged? maybePhotoMismatch(feats) : JSON.parse(JSON.stringify(feats));

    const forgedHints = [];
    if(seal==='FORGE') forgedHints.push('Visa seal looks grainy');
    if(gk==='MISMATCH') forgedHints.push('Genetic key mismatch risk');
    if(!expOk) forgedHints.push('Passport expired');
    if(photoForged) forgedHints.push('Photo ID features don\'t match live portrait');

    return {
      sp: sp.name, planet, name, dob, exp, purpose, duration, quarantine:quarant, seal,
      gk, forgedHints,
      banned:false,
      feats, photoFeats,
      liveImg:null, photoImg:null
    }
  }

  function buildQueue(){
    state.queue = Array.from({length: 5 + Math.floor(state.day/2)}, ()=>makeAlien(state.day));
    const bannedSpecies = (state.day>=3 && rand()>0.5)? pick(SPECIES).name : null;
    const quarantinePlanet = (state.day>=4 && rand()>0.5)? pick(['Aurex','Doros','Hask','Solace','Pudra']):null;
    state.todayRules = baseRules(state.day, bannedSpecies, quarantinePlanet);
  }

  function baseRules(day, bannedSpecies, quarantinePlanet){
    const rules = [
      {id:'id-match', text:'Names must be legible and present on both documents.', check:(a)=>true},
      {id:'expiry', text:'Passports must be unexpired.', check:(a)=> new Date(a.exp) >= new Date(formatDate(0)) },
      {id:'seal', text:'Visa must have a valid security seal.', check:(a)=> a.seal!=='FORGE' },
      {id:'gk', text:'Genetic Key must not be MISMATCH.', check:(a)=> a.gk!=='MISMATCH' },
      {id:'photo', text:'Photo ID must match live portrait features (eyes, arms, antennae, head, markings).', check:(a)=> sameFeatures(a.feats, a.photoFeats) }
    ];
    if(day>=3 && bannedSpecies){
      rules.push({id:'ban', text:`BANNED TODAY: ${bannedSpecies} species.`, check:(a)=> a.sp!==bannedSpecies});
    }
    if(day>=4 && quarantinePlanet){
      rules.push({id:'q', text:`Arrivals from ${quarantinePlanet} require \"Quarantine: Required\".`, check:(a)=> (a.planet!==quarantinePlanet) || (a.quarantine==='Required')});
    }
    if(day>=5){ rules.push({id:'purpose', text:'Work or Diplomacy require Visa Duration ≥ 7 days.', check:(a)=> (a.purpose==='Work'||a.purpose==='Diplomacy')?(['7 days','14 days','30 days'].includes(a.duration)):true}); }
    return rules;
  }

  function sameFeatures(a,b){
    return a.eyes===b.eyes && a.arms===b.arms && a.antennae===b.antennae && a.head===b.head && a.markings===b.markings;
  }

  // --- UI Rendering ---
  function renderHeader(){
    byId('ui-day').textContent = state.day;
    byId('ui-credits').textContent = state.credits;
    byId('ui-strikes').textContent = state.strikes;
    const rank = RANKS.reduce((acc,r)=> state.xp>=r.xp? r:acc, RANKS[0]);
    byId('ui-rank').textContent = rank.name;
    const next = RANKS.find(r=>r.xp>state.xp);
    const pct = next? ( (state.xp - rank.xp) / (next.xp - rank.xp) * 100) : 100;
    byId('xpbar').style.width = clamp(pct,0,100)+'%';
  }

  function renderRules(){
    const box=byId('rules'); box.innerHTML='';
    state.todayRules.forEach(r=>{
      const div=document.createElement('div'); div.className='rule';
      div.innerHTML = `<b>Rule:</b> ${r.text}`;
      box.appendChild(div);
    })
  }

  function renderQueue(){
    const q=byId('queue'); q.innerHTML='';
    state.queue.forEach((a)=>{
      const card=document.createElement('div'); card.className='alienCard';
      const thumb = renderAlienSVG(a.feats);
      card.innerHTML=`<div class="alienPic"><img src="${thumb}" alt="thumb" style="width:100%;height:100%;object-fit:cover"/></div><div><div><b>${a.name}</b> — ${a.sp}</div><div class="alienMeta">${a.planet} • ${a.purpose} • ${a.duration}</div></div>`;
      q.appendChild(card);
    })
  }

  function showDoc(a){
    byId('pp-species').textContent = a.sp;
    byId('pp-name').textContent = a.name;
    byId('pp-planet').textContent = a.planet;
    byId('pp-dob').textContent = a.dob;
    byId('pp-exp').textContent = a.exp;
    byId('pp-gk').textContent = a.gk;

    byId('vs-purpose').textContent = a.purpose;
    byId('vs-duration').textContent = a.duration;
    byId('vs-planet').textContent = a.planet;
    byId('vs-quar').textContent = a.quarantine;
    byId('vs-seal').textContent = a.seal;

    // Photos & feature summaries
    const liveURL = renderAlienSVG(a.feats);
    const photoURL = renderAlienSVG(a.photoFeats);
    byId('pp-live').src = liveURL; a.liveImg=liveURL;
    byId('pid-photo').src = photoURL; a.photoImg=photoURL;

    byId('pp-feats').textContent = featuresSummary(a.feats);
    byId('pid-feats').textContent = featuresSummary(a.photoFeats);
    byId('pid-caption').textContent = 'Recorded at prior docking';

    byId('pp-stamp').style.opacity=0;
    byId('vs-stamp').style.opacity=0;
    byId('pid-stamp').style.opacity=0;
  }

  function popNext(){
    if(!state.queue.length){ state.current=null; log('Queue empty. End the day to proceed.'); return; }
    state.current = state.queue.shift();
    renderQueue();
    showDoc(state.current);
    log(`Next ship: ${state.current.name} (${state.current.sp}) from ${state.current.planet}`);
  }

  // --- Adjudication Logic ---
  function evaluate(answer){
    if(!state.current){ toast('No ship selected'); return; }
    const a=state.current;
    const failures = state.todayRules.filter(r=>!r.check(a));
    const correctDecision = failures.length===0 ? 'APPROVE' : (failures.length>=2? 'DETAIN' : 'DENY');

    const ppStamp = byId('pp-stamp');
    const vsStamp = byId('vs-stamp');
    const pidStamp = byId('pid-stamp');

    if(answer==='APPROVE'){ vsStamp.style.opacity=1; vsStamp.textContent='APPROVED'; vsStamp.classList.add('ok'); }
    if(answer==='DENY'){ ppStamp.style.opacity=1; ppStamp.textContent='DENIED'; ppStamp.classList.remove('ok'); }
    if(answer==='DETAIN'){ ppStamp.style.opacity=1; ppStamp.textContent='DETAINED'; ppStamp.classList.remove('ok'); }

    // If photo mismatch exists, briefly flash stamp on photo doc when clicking docs
    if(!sameFeatures(a.feats,a.photoFeats)) pidStamp.style.opacity=0.3;

    let delta=0, xp=0;
    if(answer===correctDecision){
      delta = 5 + Math.max(0, 3 - failures.length);
      xp = 15;
      log(`✔ Correct: ${answer}. +${delta}₵`);
      toast(`Correct (+${delta}₵, +${xp}xp)`)
    } else {
      delta = -3; state.strikes++; xp = 2;
      const reason = failures.map(f=>f.id).join(', ') || 'no rule broken';
      log(`✖ Wrong: You chose ${answer} but expected ${correctDecision}. (${reason}). -3₵, Strike ${state.strikes}`);
      toast(`Incorrect (−3₵) • Strike ${state.strikes}`)
      if(state.strikes>=3){ endDay('Too many strikes. Shift ended.'); return; }
    }
    state.credits += delta; state.xp += xp;
    renderHeader();
  }

  function endDay(reason){
    state.inDay=false;
    byId('btn-newday').textContent='Start Day';
    if(reason) log(`Day ended: ${reason}`);
    const bonus = Math.max(0, (state.credits>0? Math.floor(state.credits/10):0));
    if(bonus){ state.credits += bonus; log(`Daily performance bonus: +${bonus}₵`); }
    if(state.day>=6) state.unlocked.hardMode=true;
    if(state.day>=8) state.unlocked.endless=true;
    save();
    renderHeader();
  }

  // --- Input Handlers ---
  byId('approve').addEventListener('click',()=>{ evaluate('APPROVE'); });
  byId('deny').addEventListener('click',()=>{ evaluate('DENY'); });
  byId('detain').addEventListener('click',()=>{ evaluate('DETAIN'); });
  byId('next').addEventListener('click',()=>{ popNext(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='a' || e.key==='A') evaluate('APPROVE');
    if(e.key==='d' || e.key==='D') evaluate('DENY');
    if(e.key==='f' || e.key==='F') evaluate('DETAIN');
    if(e.key==='n' || e.key==='N') popNext();
    if(e.code==='Space'){ e.preventDefault(); byId('btn-newday').click(); }
  });

  byId('btn-newday').addEventListener('click',()=>{
    if(state.inDay){ endDay('You ended the day.'); return; }
    state.inDay=true; state.strikes=0; byId('btn-newday').textContent='End Day';
    buildQueue(); renderRules(); renderQueue(); popNext(); log(`Day ${state.day} begins. New rules posted.`);
    save();
  });

  byId('btn-reset').addEventListener('click',()=>{
    if(confirm('Reset progress?')){ localStorage.removeItem(SAVE_KEY); location.reload(); }
  });

  // Click docs to reveal hints (forgery clues)
  function attachHint(el, on){
    el.addEventListener('click',()=>{
      if(!state.current) return;
      if(state.current.forgedHints && state.current.forgedHints.length){ toast(state.current.forgedHints[Math.floor(rand()*state.current.forgedHints.length)]); }
      if(on) on();
    })
  }
  attachHint(byId('passport'));
  attachHint(byId('visa'));
  attachHint(byId('photoid'), ()=>{
    if(!state.current) return;
    if(!sameFeatures(state.current.feats,state.current.photoFeats)){
      byId('pid-stamp').style.opacity = 1;
    }
  });

  // --- Boot ---
  load();
  renderHeader();
  buildQueue(); renderRules(); renderQueue();

  // Day progression: moving to next day automatically when queue is empty and still in-day
  const observer = new MutationObserver(()=>{
    if(state.inDay && !state.queue.length && state.current==null){
      state.day++; endDay('Queue cleared.');
    }
  });
  observer.observe(byId('queue'), {childList:true});

})();
</script>
</body>
</html>
