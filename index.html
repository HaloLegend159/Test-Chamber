<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alien Checkpoint — Rules + GK Scanner</title>
<style>
:root{--bg:#0b0f1a;--panel:#0f1626;--ink:#e6f0ff;--muted:#9ab;--border:#1f2a44;--paper:#f7f4e8;--inkpaper:#1e293b}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b0f1a,#08101a);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
.wrap{max-width:1200px;margin:12px auto;padding:12px}
header{display:flex;gap:10px;align-items:center;padding:10px;background:#0e1323;border-radius:10px;border:1px solid var(--border)}
.stat{padding:6px 10px;background:#0b1220;border-radius:8px;border:1px solid var(--border)}
.btn{background:#121827;border:1px solid var(--border);color:var(--ink);padding:8px 12px;border-radius:8px;cursor:pointer}
.grid{display:grid;grid-template-columns:320px 1fr 340px;gap:12px;margin-top:12px;align-items:start}
.panel{background:#0f1626;border:1px solid var(--border);border-radius:10px;overflow:auto;max-height:75vh}
.pad{padding:12px}
.queue{display:flex;flex-direction:column;gap:8px;padding:10px}
.alienCard{display:flex;gap:10px;align-items:center;padding:10px;background:#101827;border-radius:10px;border:1px dashed #223047}
.alienPic{width:56px;height:56px;border-radius:8px;background:#091225;display:grid;place-items:center;overflow:hidden}
.doc{background:var(--paper);color:var(--inkpaper);padding:10px;border-radius:8px;border:1px solid #c9c4b4;min-height:140px;position:relative}
.doc h3{margin:0 0 8px;font-weight:700}
.photo{display:flex;gap:10px;align-items:center}
.photo img{width:72px;height:72px;border-radius:6px;border:2px solid #c9c4b4;background:#fff}
.stamp{position:absolute;right:10px;bottom:10px;padding:6px 10px;border-radius:8px;border:3px solid #b33;color:#b33;font-weight:800;transform:rotate(-6deg);opacity:0}
.stamp.ok{border-color:#1d7c3a;color:#1d7c3a}
.rule{padding:8px;border-bottom:1px dashed #223047;color:var(--muted)}
.log{font-family:monospace;background:#0b1220;padding:8px;border-radius:8px;height:160px;overflow:auto;border:1px solid var(--border)}
.kbd{background:#0c1322;padding:3px 6px;border-radius:6px;border:1px solid var(--border)}
.input{padding:8px;border-radius:6px;border:1px solid var(--border);width:100%}
.small{font-size:13px;color:var(--muted)}
@media(max-width:980px){.grid{grid-template-columns:1fr} .panel{max-height:none}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-weight:700">Alien Checkpoint</div>
      <div class="stat"><b>Date:</b> <span id="ui-date">—</span></div>
      <div class="stat"><b>Day:</b> <span id="ui-day">1</span></div>
      <div class="stat"><b>Credits:</b> <span id="ui-credits">0</span></div>
      <div class="stat"><b>Strikes:</b> <span id="ui-strikes">0</span></div>
      <div class="stat"><b>Rank:</b> <span id="ui-rank">Recruit</span></div>
      <div style="flex:1"></div>
      <button class="btn" id="btn-newday">Start Day</button>
      <button class="btn" id="btn-reset">Reset</button>
    </header>

    <div class="grid">
      <section class="panel">
        <div style="padding:12px;border-bottom:1px solid #172033"><strong>Docking Queue</strong></div>
        <div class="queue pad" id="queue"></div>
      </section>

      <section class="panel">
        <div style="padding:12px;border-bottom:1px solid #172033"><strong>Inspection Desk</strong></div>
        <div class="pad" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="doc" id="passport">
            <h3>INTERSTELLAR PASSPORT</h3>
            <div class="photo" style="margin-bottom:6px">
              <img id="pp-live" alt="live" />
              <div style="font-family:monospace" id="pp-feats">—</div>
            </div>
            <table style="width:100%;font-family:monospace">
              <tr><td style="width:42%">Species</td><td id="pp-species">—</td></tr>
              <tr><td>Name</td><td id="pp-name">—</td></tr>
              <tr><td>Planet</td><td id="pp-planet">—</td></tr>
              <tr><td>Birth Cycle</td><td id="pp-dob">—</td></tr>
              <tr><td>Expires</td><td id="pp-exp">—</td></tr>
              <tr><td>Genetic Key</td><td id="pp-gk">—</td></tr>
            </table>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="scan-gk">Scan Genetic Key</button>
              <input id="manual-gk" class="input" placeholder="Type genetic code to check (e.g. GK123456)" />
              <button class="btn" id="check-gk">Check</button>
            </div>
            <div class="stamp" id="pp-stamp">DENIED</div>
          </div>

          <div class="doc" id="visa">
            <h3>DOCKING VISA</h3>
            <table style="width:100%;font-family:monospace">
              <tr><td style="width:42%">Name</td><td id="vs-name">—</td></tr>
              <tr><td>Purpose</td><td id="vs-purpose">—</td></tr>
              <tr><td>Duration</td><td id="vs-duration">—</td></tr>
              <tr><td>Planet Permit</td><td id="vs-planet">—</td></tr>
              <tr><td>Quarantine</td><td id="vs-quar">—</td></tr>
              <tr><td>Seal Code</td><td id="vs-seal">—</td></tr>
            </table>
            <div class="small" style="margin-top:8px">Valid seal format: <code>NX-123</code> (exact). Forged visas may show <code>FORGE</code>.</div>
            <div class="stamp ok" id="vs-stamp">APPROVED</div>
          </div>

          <div class="doc" id="photoid" style="grid-column:1 / span 2">
            <h3>PHOTO IDENTIFICATION</h3>
            <div class="photo" style="margin-bottom:6px">
              <img id="pid-photo" alt="photo" />
              <div>
                <div id="pid-name" style="font-weight:700">—</div>
                <div id="pid-caption" class="small">—</div>
                <div id="pid-feats" class="small" style="font-family:monospace">—</div>
              </div>
            </div>
            <div class="stamp" id="pid-stamp">MISMATCH</div>
          </div>
        </div>

        <div class="pad" style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="approve">APPROVE (A)</button>
          <button class="btn" id="deny">DENY (D)</button>
          <button class="btn" id="detain">DETAIN (F)</button>
          <button class="btn" id="next">NEXT (N)</button>
          <div style="flex:1"></div>
          <div class="small">Shortcuts: <span class="kbd">A</span>/<span class="kbd">D</span>/<span class="kbd">F</span>/<span class="kbd">N</span>, <span class="kbd">Space</span> start/end day</div>
        </div>

        <div class="pad">
          <div class="log" id="log"></div>
        </div>
      </section>

      <section class="panel">
        <div style="padding:12px;border-bottom:1px solid #172033"><strong>Regulations & Progress</strong></div>
        <div class="pad" id="rules"></div>
        <div class="pad">
          <div style="margin-bottom:8px">Progress</div>
          <div style="height:10px;background:#12203a;border-radius:8px;overflow:hidden"><div id="xpbar" style="height:100%;width:0%;background:linear-gradient(90deg,#2dd4bf,#60a5fa)"></div></div>
          <div style="margin-top:8px" class="small">Rules: Names must be legible & match Passport + Visa + Photo ID. Passports compared to current date. Valid visa seal: <code>NX-###</code>. Use Scan or manual check for genetic keys.</div>
        </div>
      </section>
    </div>
  </div>

<script>
(() => {
  const SAVE_KEY = 'alien_checkpoint_v3';
  let state = { day:1, credits:0, strikes:0, xp:0, inDay:false, queue:[], current:null, seed: Math.floor(Math.random()*1e9) };
  const SPECIES = [{name:'Zerulon',planets:['Aurex','Klyntar']},{name:'Myridian',planets:['Doros','Myra-2']},{name:'Vorx',planets:['Hask','Vortex-9']},{name:'Eldari',planets:['Solace','Nyelle']},{name:'Gubb',planets:['Pudra']}];
  const PURPOSES = ['Transit','Trade','Tourism','Work','Diplomacy'];
  const DURATIONS = ['1 day','3 days','7 days','14 days','30 days'];
  const HEADS = ['round','tall','wide','tri'];
  const MARKINGS = ['none','stripes','spots','chevrons'];
  const wantedRegistry = new Set();
  function genGK(){ return 'GK' + Math.floor(100000 + Math.floor(Math.random()*900000)); }
  wantedRegistry.add(genGK()); wantedRegistry.add(genGK());
  const byId = id => document.getElementById(id);
  function todayISO(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function rand(){ state.seed = (state.seed + 0x6D2B79F5) >>> 0; let t = state.seed; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }
  const pick = arr => arr[Math.floor(rand()*arr.length)];
  function log(msg){ const el = byId('log'); const p = document.createElement('div'); p.textContent = msg; el.prepend(p); }
  function toast(m){ const t = document.createElement('div'); t.textContent = m; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='20px'; t.style.transform='translateX(-50%)'; t.style.background='#0e1422'; t.style.padding='8px 12px'; t.style.border='1px solid #223047'; t.style.borderRadius='8px'; document.body.appendChild(t); setTimeout(()=>t.remove(),1400); }
  function makeFeatures(){ return { eyes:1+Math.floor(rand()*5), arms:2+Math.floor(rand()*4), antennae:Math.floor(rand()*3), head:pick(HEADS), markings:pick(MARKINGS), tint:`hsl(${Math.floor(rand()*360)} 70% 65%)` }; }
  function featuresSummary(f){ return `eyes:${f.eyes} | arms:${f.arms} | ant:${f.antennae} | head:${f.head} | mark:${f.markings}`; }
  function svgData(f){ const w=72,h=72,cx=36; const headPath = { round:`M18,18 a18,18 0 1,0 36,0 a18,18 0 1,0 -36,0`, tall:`M24,14 h24 a8,12 0 0,1 8,12 v12 a20,16 0 0,1 -40,0 v-12 a8,12 0 0,1 8,-12 z`, wide:`M16,24 h40 a8,10 0 0,1 0,20 h-40 a8,10 0 0,1 0,-20 z`, tri:`M36,14 L56,44 H16 Z` }[f.head]; const eyes = Array.from({length:f.eyes},(_,i)=>{ const spread=Math.min(12,4*(f.eyes-1)); const x=cx-spread/2+(i*(spread/(Math.max(1,f.eyes-1)))); return `<circle cx="${x.toFixed(1)}" cy="32" r="3" fill="#111"/>`;}).join(''); const ants = Array.from({length:f.antennae},(_,i)=>{ const x=cx+(i-(f.antennae-1)/2)*8; return `<path d="M${x},18 q-4,-8 -8,-12" stroke="#333" stroke-width="2" fill="none"/>`;}).join(''); const mark = f.markings==='none' ? '' : (f.markings==='stripes' ? `<path d="M22,28 h28 M22,36 h28" stroke="#0005" stroke-width="3"/>` : f.markings==='spots' ? `<circle cx="26" cy="30" r="2" fill="#0005"/><circle cx="46" cy="36" r="2" fill="#0005"/>` : `<path d="M24,34 l12,-8 l12,8" stroke="#0005" stroke-width="3" fill="none"/>`); const arms = Array.from({length:f.arms},(_,i)=>{ const x=16+i*(40/(f.arms-1||1)); return `<rect x="${x-2}" y="44" width="4" height="14" rx="2" fill="#7aa3"/>`;}).join(''); const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'><rect width='${w}' height='${h}' fill='white'/><g><rect x='14' y='42' width='44' height='18' rx='8' fill='${f.tint}'/><path d='${headPath}' fill='${f.tint}' stroke='#0004' stroke-width='1'/>${mark}${ants}${eyes}${arms}</g></svg>`; return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }
  function makeAlien(){ const sp = pick(SPECIES); const name = pick(['Ryll','Kora','Jent','Zux','Mira','Torv','Plek','Lena','Qir','Brol']) + ' ' + pick(['Zeen','Tark','Vel','Qor','Dax','Meln','Iri','Sorn']); const planet = pick(sp.planets); const dob = `${2440+Math.floor(rand()*40)}-${String(1+Math.floor(rand()*12)).padStart(2,'0')}-${String(1+Math.floor(rand()*27)).padStart(2,'0')}`; const expOk = Math.random()>0.18; const exp = expOk ? (new Date(Date.now() + (2+Math.floor(Math.random()*30))*24*3600*1000)).toISOString().slice(0,10) : (new Date(Date.now() - (1+Math.floor(Math.random()*10))*24*3600*1000)).toISOString().slice(0,10); const purpose = pick(PURPOSES); const duration = pick(DURATIONS); const seal = (Math.random()>0.15) ? 'NX-'+(100+Math.floor(Math.random()*900)) : 'FORGE'; const gk = 'GK' + Math.floor(100000 + Math.floor(rand()*900000)); const feats = makeFeatures(); const photoForged = Math.random()>0.82; const photoFeats = photoForged ? (() => { const x = JSON.parse(JSON.stringify(feats)); const k = pick(['eyes','arms','antennae','head','markings']); if(k==='eyes') x.eyes = Math.max(1, Math.min(5, x.eyes + (rand()>0.5?1:-1))); if(k==='arms') x.arms = Math.max(2, Math.min(5, x.arms + (rand()>0.5?1:-1))); if(k==='antennae') x.antennae = Math.max(0, Math.min(2, x.antennae + (rand()>0.5?1:-1))); if(k==='head') x.head = pick(HEADS.filter(h=>h!==x.head)); if(k==='markings') x.markings = pick(MARKINGS.filter(m=>m!==x.markings)); return x; })() : JSON.parse(JSON.stringify(feats)); const vsSmudged = Math.random()>0.85; const vsName = vsSmudged ? name.split('').map((c,i)=> i>0 && i<name.length-1 && Math.random()>0.6 ? '·' : c).join('') : name; const forgedHints = []; if(seal==='FORGE') forgedHints.push('Visa seal looks grainy'); if(!expOk) forgedHints.push('Passport expired'); if(photoForged) forgedHints.push('Photo ID features differ'); if(vsSmudged) forgedHints.push('Visa name appears smudged'); return { sp:sp.name, planet, name, vsName, vsSmudged, pidName:name, dob, exp, purpose, duration, quarantine:'None', seal, gk, feats, photoFeats, forgedHints, _gkScanned:false, _gkFlagged:false }; }
  function baseRules(){ return [ { id:'name', text:'Names must be legible and present on Passport, Visa, and Photo ID and they must match exactly.', check: a => !!a.name && !!a.vsName && !!a.pidName && !a.vsSmudged && a.name===a.vsName && a.name===a.pidName }, { id:'expiry', text:'Passports must be unexpired (compared to current date).', check: a => (new Date(a.exp+'T00:00:00') >= new Date(todayISO()+'T00:00:00')) }, { id:'seal', text:'Visa must have a valid security seal (NX-###).', check: a => /^NX-\d{3}$/.test(a.seal) }, { id:'gk', text:'Genetic Key must not be flagged as wanted when scanned/checked.', check: a => a._gkFlagged !== true }, { id:'photo', text:'Photo ID features must match live portrait (eyes/arms/antennae/head/markings).', check: a => JSON.stringify(a.feats) === JSON.stringify(a.photoFeats) } ]; }
  function renderHeader(){ byId('ui-day').textContent = state.day; byId('ui-credits').textContent = state.credits; byId('ui-strikes').textContent = state.strikes; byId('ui-date').textContent = todayISO(); const progress = Math.min(100, Math.max(0, (state.xp / 120) * 100)); byId('xpbar').style.width = progress + '%'; }
  function renderRules(){ const r = baseRules(); const el = byId('rules'); el.innerHTML = ''; r.forEach(rule => { const d = document.createElement('div'); d.className = 'rule'; d.innerHTML = `<strong>Rule:</strong> ${rule.text}`; el.appendChild(d); }); state.todayRules = r; }
  function renderQueue(){ const q = byId('queue'); q.innerHTML = ''; state.queue.forEach((a) => { const card = document.createElement('div'); card.className='alienCard'; card.innerHTML = `<div class="alienPic"><img src="${svgData(a.feats)}" style="width:100%;height:100%;object-fit:cover"/></div><div style="flex:1"><div style="font-weight:700">${a.name}</div><div class="small">${a.sp} — ${a.planet}</div><div class="small" style="color:#9ab">${a.purpose} • ${a.duration}</div></div>`; card.addEventListener('click', ()=> { state.current = a; showDoc(a); log('Selected: ' + a.name); }); q.appendChild(card); }); }
  function showDoc(a){ byId('pp-species').textContent = a.sp; byId('pp-name').textContent = a.name; byId('pp-planet').textContent = a.planet; byId('pp-dob').textContent = a.dob; byId('pp-exp').textContent = a.exp; byId('pp-gk').textContent = a.gk; byId('vs-name').textContent = a.vsName; byId('vs-purpose').textContent = a.purpose; byId('vs-duration').textContent = a.duration; byId('vs-planet').textContent = a.planet; byId('vs-quar').textContent = a.quarantine; byId('vs-seal').textContent = a.seal; byId('pid-photo').src = svgData(a.photoFeats); byId('pid-name').textContent = a.pidName; byId('pid-caption').textContent = a.forgedHints && a.forgedHints.length ? a.forgedHints[0] : 'Recorded at prior docking'; byId('pid-feats').textContent = featuresSummary(a.photoFeats); byId('pp-feats').textContent = featuresSummary(a.feats); ['pp-stamp','vs-stamp','pid-stamp'].forEach(id=>byId(id).style.opacity=0); }
  function buildQueue(){ state.queue = Array.from({length:5 + Math.floor(state.day/2)}, ()=>makeAlien()); renderRules(); renderQueue(); }
  function popNext(){ if(!state.queue.length){ toast('Queue empty — end the day.'); state.current = null; return; } state.current = state.queue.shift(); renderQueue(); showDoc(state.current); log('Next: ' + state.current.name); }
  function scanGenetic(){ const a = state.current; if(!a) { toast('No applicant selected'); return; } a._gkScanned = true; const flagged = wantedRegistry.has(a.gk); a._gkFlagged = flagged; byId('pp-gk').textContent = a.gk + (flagged ? ' (WANTED)' : ''); log('*SCANNER*: ' + a.gk + (flagged ? ' — WANTED' : ' — CLEAR')); toast(flagged ? 'WANTED genetic match!' : 'Genetic code scanned — clear'); }
  function manualCheck(){ const code = byId('manual-gk').value.trim(); if(!code){ toast('Type a genetic code to check'); return; } const flagged = wantedRegistry.has(code); if(!state.current){ toast('No current applicant'); return; } if(flagged){ state.current._gkFlagged = true; byId('pp-gk').textContent = state.current.gk + ' (WANTED)'; log('Manual check: ' + code + ' flagged'); toast('Manual check: WANTED'); } else { log('Manual check: ' + code + ' not found'); toast('Manual check: not found'); } }
  function evaluate(action){ if(!state.current){ toast('No applicant'); return; } const a = state.current; const failures = state.todayRules.filter(r => !r.check(a)); const wanted = !!a._gkFlagged; const expected = wanted ? 'DETAIN' : (failures.length === 0 ? 'APPROVE' : (failures.length >= 2 ? 'DETAIN' : 'DENY')); if(action === 'APPROVE'){ byId('vs-stamp').style.opacity = 1; byId('vs-stamp').classList.add('ok'); byId('vs-stamp').textContent = 'APPROVED'; } if(action === 'DENY'){ byId('pp-stamp').style.opacity = 1; byId('pp-stamp').classList.remove('ok'); byId('pp-stamp').textContent = 'DENIED'; } if(action === 'DETAIN'){ byId('pp-stamp').style.opacity = 1; byId('pp-stamp').textContent = 'DETAINED'; } if(JSON.stringify(a.feats) !== JSON.stringify(a.photoFeats)) byId('pid-stamp').style.opacity = 1; if(action === expected){ const gain = 5 + Math.max(0, 3 - failures.length); const xp = 10; state.credits += gain; state.xp += xp; log('✔ Correct: ' + action + ' • +' + gain + ' credits'); toast('Correct decision'); } else { state.credits -= 3; state.strikes++; log('✖ Wrong: chose ' + action + ' expected ' + expected + ' • -3 credits'); toast('Incorrect decision'); if(state.strikes >= 3){ endDay('Too many strikes'); return; } } state.current = null; if(state.queue.length) { popNext(); } else { toast('Queue empty — end the day when ready'); } renderHeader(); }
  function endDay(reason){ state.inDay = false; byId('btn-newday').textContent = 'Start Day'; if(reason) log('Day ended: ' + reason); localStorage.setItem(SAVE_KEY, JSON.stringify({ day: state.day, credits: state.credits, xp: state.xp })); }
  byId('btn-newday').addEventListener('click', () => { if(state.inDay){ endDay('User ended day'); return; } state.inDay = true; byId('btn-newday').textContent = 'End Day'; state.strikes = 0; buildQueue(); renderHeader(); popNext(); log('Day ' + state.day + ' started'); });
  byId('next').addEventListener('click', popNext); byId('approve').addEventListener('click', ()=> evaluate('APPROVE')); byId('deny').addEventListener('click', ()=> evaluate('DENY')); byId('detain').addEventListener('click', ()=> evaluate('DETAIN')); byId('scan-gk').addEventListener('click', scanGenetic); byId('check-gk').addEventListener('click', manualCheck); byId('btn-reset').addEventListener('click', ()=> { if(confirm('Reset progress?')) { localStorage.removeItem(SAVE_KEY); location.reload(); } });
  document.addEventListener('keydown', e => { if(e.key==='a'||e.key==='A') evaluate('APPROVE'); if(e.key==='d'||e.key==='D') evaluate('DENY'); if(e.key==='f'||e.key==='F') evaluate('DETAIN'); if(e.key==='n'||e.key==='N') popNext(); if(e.code==='Space'){ e.preventDefault(); byId('btn-newday').click(); } });
  byId('ui-date').textContent = todayISO();
  state.queue = Array.from({length:5}, ()=>makeAlien());
  renderRules();
  renderQueue();

  // --- Minimal self-tests to prevent regressions ---
  function assertTest(name, cond){
    if(cond){ log('[TEST PASS] ' + name); return true; }
    else { log('[TEST FAIL] ' + name); return false; }
  }
  function runSelfTests(){
    const saved = {current: state.current, todayRules: state.todayRules, queue: state.queue.slice(), credits: state.credits, strikes: state.strikes};
    let pass = true;
    try{
      const rules = baseRules();
      // Build a minimal valid applicant
      const base = {name:'A B', vsName:'A B', pidName:'A B', vsSmudged:false, exp: new Date(Date.now()+3*86400000).toISOString().slice(0,10), seal:'NX-123', _gkFlagged:false, feats:{eyes:2,arms:2,antennae:0,head:'round',markings:'none',tint:'#fff'}, photoFeats:{eyes:2,arms:2,antennae:0,head:'round',markings:'none',tint:'#fff'}, planet:'X', sp:'Z', purpose:'Transit', duration:'1 day', quarantine:'None', gk:'GK123456'};
      pass &= assertTest('expiry valid', rules[1].check(base));
      const past = {...base, exp:new Date(Date.now()-86400000).toISOString().slice(0,10)};
      pass &= assertTest('expiry invalid', !rules[1].check(past));
      pass &= assertTest('seal valid', rules[2].check(base));
      pass &= assertTest('seal invalid', !rules[2].check({...base, seal:'FORGE'}));
      pass &= assertTest('name legible mismatch', !rules[0].check({...base, vsSmudged:true}));
      pass &= assertTest('names must match', !rules[0].check({...base, vsName:'A C'}));
      pass &= assertTest('names match', rules[0].check(base));
      // Exercise evaluate() else branch (used to throw SyntaxError)
      state.todayRules = rules; state.current = base; evaluate('DENY');
    }catch(e){ pass=false; log('[TEST ERROR] ' + (e && e.message ? e.message : e)); }
    // Restore state minimally
    state.current = saved.current; state.todayRules = saved.todayRules; state.queue = saved.queue; state.credits = saved.credits; state.strikes = saved.strikes; renderHeader(); renderQueue();
    log('[TEST] Completed ' + (pass? 'OK' : 'with failures'));
  }
  runSelfTests();
})();
</script>
</body>
</html>
