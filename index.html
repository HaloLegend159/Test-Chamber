<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ghost Hunt v1.3 – Solid Flashlight + Smooth Temps</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{--bg:#0b0f14;--panel:#0e1624;--ink:#e6f0ff;--muted:#9db0d7;--border:#1a2537}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 60% -10%, #122034 0%, #0b0f14 60%);color:var(--ink);
       font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  .wrap{display:grid;grid-template-columns:1fr 340px;gap:16px;max-width:1320px;margin:12px auto;padding:0 12px 40px}
  #gameArea{position:relative;background:#06090f;border:1px solid var(--border);border-radius:14px;overflow:hidden;min-height:70vh}
  canvas{display:block;width:100%;height:100%}
  aside{position:sticky;top:12px;align-self:start;background:linear-gradient(180deg,#0e1624,#0c1320);
        border:1px solid var(--border);border-radius:14px;padding:14px}
  .btn{border:1px solid var(--border);background:#121a2a;color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer;width:100%}
  .btn:hover{background:#16233a}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{display:inline-block;background:#0a1322;border:1px solid #1b2a45;border-radius:999px;padding:6px 10px;margin:6px 6px 0 0;color:#a7b9dc}
  .hint{position:absolute;right:10px;top:10px;color:#93accf;background:#0a1322;border:1px solid #203252;border-radius:999px;padding:6px 10px;z-index:5}
  .modal{position:fixed;inset:0;background:rgba(2,6,14,.6);display:none;place-items:center;padding:20px;z-index:30}
  .modal.show{display:grid}
  .sheet{width:min(920px,95vw);max-height:90vh;overflow:auto;background:#0c1423;border:1px solid var(--border);border-radius:14px;padding:16px}
  .evidence-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
  .evi{border:1px solid var(--border);border-radius:12px;padding:8px;background:#0a1322}
  .ghosts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
  .ghost{border:1px dashed #21314e;border-radius:12px;padding:10px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0a1322;border:1px solid var(--border);border-radius:999px;padding:8px 14px;color:#9db0d7;z-index:40;display:none}
  .kbd{padding:2px 6px;border:1px solid #2b3f5a;border-radius:6px;background:#0b1424;font:600 12px ui-monospace,Menlo,Consolas}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} aside{position:static} }
</style>
</head>
<body>
<div class="wrap">
  <div id="gameArea">
    <canvas id="game"></canvas>
    <div class="hint">
      WASD move • Mouse aims • <span class="kbd">J</span> Journal • <span class="kbd">F</span> Flashlight •
      <span class="kbd">V</span> Spirit Box • <span class="kbd">U</span> UV Lamp
    </div>
  </div>
  <aside>
    <h3 style="margin:.2rem 0 .4rem 0">GHOST HUNT <span style="color:#9db0d7;font-weight:600">v1.3</span></h3>
    <button class="btn" id="newRun">Start New Contract</button>

    <div class="row" style="margin-top:8px">
      <span class="chip" id="sanityVal">Sanity 100%</span>
      <span class="chip">EMF <b id="emfVal">1</b></span>
      <span class="chip">Temp <b id="tempVal">21.0°C</b></span>
      <span class="chip">Box <b id="boxVal">Idle</b></span>
      <span class="chip">UV <b id="uvVal">OFF</b></span>
    </div>

    <div style="margin-top:10px;color:#9db0d7;font-size:12px">
      Find 3 evidences, pick the ghost in the Journal, then exit via the van (green square).
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="openJournal">Open Journal (J)</button>
      <button class="btn" id="howTo">How to Play</button>
    </div>
    <div style="margin-top:10px;color:#9db0d7;font-size:12px">Flashlight: <b id="flashStat">ON</b> • Battery <span id="batPct">100%</span></div>
  </aside>
</div>

<!-- JOURNAL -->
<div class="modal" id="journal">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h2 style="margin:0">Journal</h2>
      <button class="btn" id="closeJournal" style="width:auto">Close</button>
    </div>
    <p style="color:#9db0d7;font-size:12px;margin:.4rem 0 0.6rem 0">
      Tick evidence you’ve found. You can freely untick anything—tools will never force-check boxes.
    </p>
    <div class="evidence-grid">
      <div class="evi"><label><input type="checkbox" data-evi="EMF5"> EMF Level 5</label></div>
      <div class="evi"><label><input type="checkbox" data-evi="Freezing"> Freezing Temperatures (≤ 0°C)</label></div>
      <div class="evi"><label><input type="checkbox" data-evi="SpiritBox"> Spirit Box</label></div>
      <div class="evi"><label><input type="checkbox" data-evi="Orbs"> Ghost Orbs</label></div>
      <div class="evi"><label><input type="checkbox" data-evi="Fingerprints"> Fingerprints (UV)</label></div>
      <div class="evi"><label><input type="checkbox" data-evi="Writing"> Ghost Writing</label></div>
    </div>
    <div id="ghostList" class="ghosts"></div>
  </div>
</div>

<!-- HOW TO -->
<div class="modal" id="help">
  <div class="sheet">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
      <h2 style="margin:0">How to Play</h2>
      <button class="btn" id="closeHelp" style="width:auto">Close</button>
    </div>
    <ol>
      <li>Move with <span class="kbd">WASD</span>. Aim flashlight with the mouse. Toggle with <span class="kbd">F</span>.</li>
      <li>Tools: EMF (auto), Thermometer (auto), Spirit Box (<span class="kbd">V</span> to hold), UV Lamp (<span class="kbd">U</span> to toggle).</li>
      <li>Ghost Writing may appear if you linger in the ghost room.</li>
      <li>Open <span class="kbd">J</span> to tick evidence and select a ghost. Exit via the green van to submit.</li>
      <li>Sanity drains in darkness; at low sanity the ghost hunts. Don’t get caught!</li>
    </ol>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(()=>{
// ===== Canvas setup =====
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const gameArea = document.getElementById('gameArea');
let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
function sizeCanvas(){
  const rect = gameArea.getBoundingClientRect();
  const w = Math.max(640, Math.floor(rect.width));
  const h = Math.max(420, Math.floor(rect.height));
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  canvas.width  = Math.floor(w * DPR);
  canvas.height = Math.floor(h * DPR);
  canvas.style.width = w + 'px';
  canvas.style.height = h + 'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
sizeCanvas();
window.addEventListener('resize', sizeCanvas);

// ===== Helpers =====
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const inside=(p,r)=>p.x>r.x && p.x<r.x+r.w && p.y>r.y && p.y<r.y+r.h;

// ===== State =====
const state = {
  running:false,time:0,dt:0,last:0,
  keys:new Set(),mouse:{x:200,y:200},
  flashlight:true,battery:1,holdingBox:false, uv:false,
  sanity:100, emf:1,
  temp:21, tempTarget:21, tempSmooth:21, tempTimer:0, // << smoothing timers
  box:"Idle", linger:0,
  evidences:{EMF5:false,Freezing:false,SpiritBox:false,Orbs:false,Fingerprints:false,Writing:false},
  found:{EMF5:false,Freezing:false,SpiritBox:false,Orbs:false,Fingerprints:false,Writing:false},
  map:null, player:null, ghost:null, ghostRoom:null, vanZone:null,
  orbs:[], prints:[], writingSpots:[], writingVisible:false,
  inHunt:false, huntTimer:0, gameOver:false, won:false, selectedGhost:null
};

const EVI = ["EMF5","Freezing","SpiritBox","Orbs","Fingerprints","Writing"];

const GHOSTS = [
  {name:"Phantom",  ev:["EMF5","SpiritBox","Orbs"], notes:"Shy; vanishes during events."},
  {name:"Wraith",   ev:["EMF5","SpiritBox","Freezing"], notes:"Floats; aggressive if provoked."},
  {name:"Yurei",    ev:["Freezing","Orbs","EMF5"], notes:"Drains sanity in darkness."},
  {name:"Mare",     ev:["SpiritBox","Orbs","Freezing"], notes:"Prefers dark rooms."},
  {name:"Shade",    ev:["EMF5","Orbs","Freezing"], notes:"Hunts at low sanity."},
  {name:"Revenant", ev:["Writing","Freezing","EMF5"], notes:"Deadly when you’re seen."},
  {name:"Demon",    ev:["Freezing","Writing","SpiritBox"], notes:"Early hunts at higher sanity."},
  {name:"Polter",   ev:["SpiritBox","Fingerprints","Orbs"], notes:"Very active; leaves many marks."},
  {name:"Banshee",  ev:["Fingerprints","Orbs","Freezing"], notes:"Tracks a single target."},
  {name:"Myling",   ev:["EMF5","Writing","Fingerprints"], notes:"Quiet hunts; strong evidence."},
];

// ===== Map =====
function buildMap(){
  const rooms = [
    {x:60,y:60,w:280,h:200,name:"Entrance"},
    {x:380,y:60,w:280,h:180,name:"Living"},
    {x:700,y:60,w:260,h:200,name:"Garage"},
    {x:60,y:300,w:280,h:220,name:"Hall"},
    {x:380,y:270,w:260,h:250,name:"Bedroom"},
    {x:680,y:300,w:280,h:240,name:"Kitchen"},
  ];
  const doors = [
    {x:340,y:150,w:20,h:40},{x:660,y:140,w:20,h:40},
    {x:380,y:260,w:40,h:20},{x:170,y:260,w:60,h:20},
    {x:340,y:420,w:20,h:40},{x:680,y:260,w:40,h:20},
  ];
  const van = {x:20,y:20,w:40,h:40};
  return {rooms,doors,van};
}

// ===== Entities =====
const newPlayer=()=>({x:90,y:90,r:10,spd:160,angle:0,alive:true});
function newGhost(){
  const g = GHOSTS[Math.floor(Math.random()*GHOSTS.length)];
  return {type:g.name, evidences:new Set(g.ev), x:750,y:140,speed:95,roam:0,target:null};
}

// ===== UI =====
const sanityVal=document.getElementById('sanityVal');
const emfVal=document.getElementById('emfVal');
const tempVal=document.getElementById('tempVal');
const boxVal=document.getElementById('boxVal');
const flashStat=document.getElementById('flashStat');
const uvVal=document.getElementById('uvVal');
const batPct=document.getElementById('batPct');
const toastEl=document.getElementById('toast');

function toast(msg,ms=1600){
  toastEl.textContent=msg; toastEl.style.display='block';
  clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display='none',ms);
}

// ===== Journal =====
function updateJournalList(){
  const list=document.getElementById('ghostList'); list.innerHTML='';
  const checked=EVI.filter(k=>state.evidences[k]);
  const pool=GHOSTS.filter(g=>checked.every(k=>g.ev.includes(k)));
  (pool.length?pool:GHOSTS).forEach(g=>{
    const badges = g.ev.map(x=> state.found[x] ? ` <span style="color:#86efac">[observed]</span>` : '' );
    const el=document.createElement('div'); el.className='ghost';
    el.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div>
          <strong>${g.name}</strong>
          <div style="color:#9db0d7;font-size:12px">${g.ev.map((e,i)=>`${e}${badges[i]||''}`).join(' • ')}</div>
          <div style="color:#88a0c7;font-size:12px">${g.notes||''}</div>
        </div>
        <button class="btn" data-choose="${g.name}" style="width:auto">Select</button>
      </div>`;
    list.appendChild(el);
  });
  list.querySelectorAll('[data-choose]').forEach(b=>{
    b.onclick=()=>{state.selectedGhost=b.dataset.choose; toast(`Selected: ${state.selectedGhost}. Exit via van to submit.`,2000);}
  });
}

// ===== Modals & inputs =====
function toggleModal(id,show){const m=document.getElementById(id); m.classList.toggle('show', show===undefined ? !m.classList.contains('show') : show);}
document.getElementById('openJournal').onclick=()=>{toggleModal('journal',true);updateJournalList();}
document.getElementById('closeJournal').onclick=()=>toggleModal('journal',false);
document.getElementById('howTo').onclick=()=>toggleModal('help',true);
document.getElementById('closeHelp').onclick=()=>toggleModal('help',false);
document.querySelectorAll('[data-evi]').forEach(cb=>{
  cb.addEventListener('change',()=>{state.evidences[cb.dataset.evi]=cb.checked; updateJournalList();});
});

window.addEventListener('keydown',e=>{
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  const k=e.key.toLowerCase();
  state.keys.add(k);
  if(k==='j') {toggleModal('journal',true); updateJournalList();}
  if(k==='f') {state.flashlight=!state.flashlight; flashStat.textContent=state.flashlight?'ON':'OFF';}
  if(k==='u') {state.uv=!state.uv; uvVal.textContent=state.uv?'ON':'OFF';}
  if(k==='v') state.holdingBox=true;
});
window.addEventListener('keyup',e=>{const k=e.key.toLowerCase(); state.keys.delete(k); if(k==='v'){state.holdingBox=false; state.box='Idle';}});
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect();
  const sx=canvas.width/r.width, sy=canvas.height/r.height;
  state.mouse.x=(e.clientX-r.left)*sx/DPR;
  state.mouse.y=(e.clientY-r.top)*sy/DPR;
});

// ===== Game setup & loop =====
function reset(){
  state.map=buildMap();
  state.player=newPlayer();
  state.ghost=newGhost();
  state.ghostRoom=state.map.rooms[Math.floor(Math.random()*state.map.rooms.length)];
  state.vanZone=state.map.van;

  state.orbs=[]; state.prints=[]; state.writingSpots=[]; state.writingVisible=false;
  if(state.ghost.evidences.has("Orbs")){
    for(let i=0;i<24;i++){
      state.orbs.push({x:rand(state.ghostRoom.x+20,state.ghostRoom.x+state.ghostRoom.w-20),
                       y:rand(state.ghostRoom.y+20,state.ghostRoom.y+state.ghostRoom.h-20),
                       r:rand(1.2,2.2),a:rand(0,Math.PI*2),s:rand(0.6,1.2)});
    }
  }
  if(state.ghost.evidences.has("Fingerprints")){
    for(let i=0;i<5;i++){
      state.prints.push({x:rand(state.ghostRoom.x+18,state.ghostRoom.x+state.ghostRoom.w-18),
                         y:rand(state.ghostRoom.y+18,state.ghostRoom.y+state.ghostRoom.h-18),
                         r:rand(5,8),a:rand(0,Math.PI*2)});
    }
  }
  if(state.ghost.evidences.has("Writing")){
    for(let i=0;i<2;i++){
      state.writingSpots.push({x:rand(state.ghostRoom.x+30,state.ghostRoom.x+state.ghostRoom.w-30),
                               y:rand(state.ghostRoom.y+30,state.ghostRoom.y+state.ghostRoom.h-30)});
    }
  }

  state.flashlight=true; state.uv=false; state.battery=1;
  state.sanity=100; state.emf=1;

  // temperature smoothing
  state.temp=21; state.tempSmooth=21; state.tempTarget=21; state.tempTimer=0;

  state.box='Idle'; state.linger=0;
  state.evidences={EMF5:false,Freezing:false,SpiritBox:false,Orbs:false,Fingerprints:false,Writing:false};
  state.found={EMF5:false,Freezing:false,SpiritBox:false,Orbs:false,Fingerprints:false,Writing:false};
  state.inHunt=false; state.huntTimer=0; state.gameOver=false; state.won=false; state.selectedGhost=null;
  state.time=0; state.last=performance.now(); state.running=true;
  toast('New Contract started.');
  updateJournalList();
}
document.getElementById('newRun').onclick=reset;
reset();

function loop(now){
  if(!state.running){requestAnimationFrame(loop);return;}
  state.dt=Math.min(0.033,(now-state.last)/1000); state.last=now; state.time+=state.dt;
  update(state.dt); draw(); requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// ===== Update =====
function update(dt){
  if(state.gameOver||state.won) return;
  const p=state.player;

  // movement
  let dx=0,dy=0;
  if(state.keys.has('w'))dy-=1; if(state.keys.has('s'))dy+=1;
  if(state.keys.has('a'))dx-=1; if(state.keys.has('d'))dx+=1;
  const L=Math.hypot(dx,dy)||1; dx/=L; dy/=L;
  p.x=clamp(p.x+dx*p.spd*dt,10, canvas.width/DPR-10);
  p.y=clamp(p.y+dy*p.spd*dt,10, canvas.height/DPR-10);
  const targetAngle=Math.atan2(state.mouse.y-p.y,state.mouse.x-p.x);
  p.angle += (targetAngle - p.angle) * 0.25;

  // battery + sanity
  if(state.flashlight) state.battery=Math.max(0,state.battery-dt*0.015);
  document.getElementById('batPct').textContent=Math.round(state.battery*100)+'%';
  const darkFactor=(state.flashlight&&state.battery>0)?0.25:1.0;
  state.sanity=clamp(state.sanity - dt*(0.6*darkFactor + (state.inHunt?1.4:0)), 0, 100);
  sanityVal.textContent=`Sanity ${Math.round(state.sanity)}%`;

  // ghost roam
  const g=state.ghost;
  g.roam-=dt;
  if(g.roam<=0){
    const r=state.ghostRoom;
    g.target={x:rand(r.x+30,r.x+r.w-30),y:rand(r.y+30,r.y+r.h-30)};
    g.roam=rand(1.4,3.2);
  }
  if(g.target){
    const mx=g.target.x-g.x, my=g.target.y-g.y, d=Math.hypot(mx,my)||1;
    if(d>2){ g.x+=mx/d*g.speed*dt*(state.inHunt?1.8:1); g.y+=my/d*g.speed*dt*(state.inHunt?1.8:1); }
  }

  // --------- MUCH SMOOTHER TEMPERATURE ---------
  // Update target only every ~1.2s (prevents jittery spam)
  state.tempTimer -= dt;
  if(state.tempTimer<=0){
    const base = inside(p,state.ghostRoom) ? rand(-1.0,3.0) : rand(20.0,22.0);
    // keep target near previous target (gentle drift)
    state.tempTarget = state.tempTarget*0.7 + base*0.3;
    state.tempTimer = 1.2; // seconds
  }
  // Ease toward target with small noise
  const smoothK = Math.min(1, dt*0.35);   // smaller = smoother
  state.tempSmooth += (state.tempTarget - state.tempSmooth) * smoothK;
  state.temp = state.tempSmooth + (Math.random()*0.04 - 0.02); // tiny ±0.02 noise
  // snap to 0.1 for a calmer display
  const displayTemp = Math.round(state.temp*10)/10;
  tempVal.textContent = displayTemp.toFixed(1)+'°C';
  if(displayTemp<=0 && state.ghost.evidences.has("Freezing")) state.found.Freezing=true;

  // EMF
  const dpg=dist(p,g);
  let emf=1; if(dpg<220)emf=2; if(dpg<160)emf=3; if(dpg<120)emf=4; if(dpg<80)emf=5;
  if(state.inHunt) emf=5;
  state.emf=emf; emfVal.textContent=emf.toFixed(0);
  if(emf>=5 && state.ghost.evidences.has("EMF5")) state.found.EMF5=true;

  // Spirit Box
  if(state.holdingBox){
    if(dpg<110 && state.ghost.evidences.has("SpiritBox") && Math.random()<0.015){
      state.box="…whisper… RUN"; state.found.SpiritBox=true;
    }else state.box="Scanning…";
  }else state.box="Idle";
  boxVal.textContent=state.box;

  // Fingerprints (UV + in room)
  if(state.uv && state.ghost.evidences.has("Fingerprints") && inside(p,state.ghostRoom)){
    if(Math.random()<0.01) state.found.Fingerprints=true;
  }

  // Writing (linger)
  if(state.ghost.evidences.has("Writing")){
    if(inside(p,state.ghostRoom)) state.linger += dt; else state.linger = Math.max(0, state.linger - dt*0.5);
    if(!state.writingVisible && state.linger>6){
      state.writingVisible=true; state.found.Writing=true; toast('You notice scribbles in the book…',1800);
    }
  }

  // Orbs observed if you are in ghost room
  if(state.ghost.evidences.has("Orbs") && inside(p,state.ghostRoom)){
    if(Math.random()<0.012) state.found.Orbs=true;
  }

  // hunts
  if(!state.inHunt && (state.sanity<40 || (state.sanity<60 && Math.random()<0.001))){
    state.inHunt=true; state.huntTimer=rand(8,14); toast('The ghost is hunting! Hide!',1500);
  }
  if(state.inHunt){
    state.huntTimer-=dt;
    const mx=p.x-g.x, my=p.y-g.y, d=Math.hypot(mx,my)||1;
    g.x+=mx/d*(g.speed*1.6)*dt; g.y+=my/d*(g.speed*1.6)*dt;
    if(d<18){ state.gameOver=true; toast('You were caught…',2200); }
    if(state.huntTimer<=0) state.inHunt=false;
  }

  // submit at van
  if(inside(p,state.map.van) && state.selectedGhost){
    const correct=state.selectedGhost===state.ghost.type;
    state.won=correct; state.gameOver=!correct;
    toast(correct?`Correct! It was a ${state.ghost.type}.`:`Wrong! It was a ${state.ghost.type}.`,2800);
  }
}

// ===== Draw =====
function draw(){
  const w = canvas.width/DPR, h = canvas.height/DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
  ctx.clearRect(0,0,w,h);

  // world base
  ctx.fillStyle='#06090f'; ctx.fillRect(0,0,w,h);
  for(const r of state.map.rooms){ ctx.fillStyle='#0a101b'; ctx.fillRect(r.x,r.y,r.w,r.h); ctx.strokeStyle='#1a263b'; ctx.strokeRect(r.x,r.y,r.w,r.h); }
  for(const d of state.map.doors){ ctx.fillStyle='#152239'; ctx.fillRect(d.x,d.y,d.w,d.h); }
  const van=state.map.van; ctx.fillStyle='#0f2b17'; ctx.fillRect(van.x,van.y,van.w,van.h); ctx.strokeStyle='#2e6a40'; ctx.strokeRect(van.x,van.y,van.w,van.h);

  // orbs
  if(state.ghost.evidences.has("Orbs")){
    for(const o of state.orbs){
      o.a+=0.02*o.s; o.x+=Math.cos(o.a)*0.2; o.y+=Math.sin(o.a)*0.2;
      if(!inside(o,state.ghostRoom)){ o.x=clamp(o.x,state.ghostRoom.x+10,state.ghostRoom.x+state.ghostRoom.w-10);
                                      o.y=clamp(o.y,state.ghostRoom.y+10,state.ghostRoom.y+state.ghostRoom.h-10);}
      ctx.globalAlpha=0.6; ctx.fillStyle='#9ff'; ctx.beginPath(); ctx.arc(o.x,o.y,o.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    }
  }

  // fingerprints (UV)
  if(state.uv && state.ghost.evidences.has("Fingerprints")){
    ctx.globalAlpha = 0.9;
    for(const f of state.prints){
      ctx.save(); ctx.translate(f.x,f.y); ctx.rotate(f.a);
      ctx.fillStyle='#8cffd5'; ctx.beginPath(); ctx.ellipse(0,0,f.r, f.r*0.6, 0, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
    ctx.globalAlpha = 1;
  }

  // writing
  if(state.writingVisible){
    ctx.fillStyle='#d1cab1';
    for(const s of state.writingSpots){
      ctx.fillRect(s.x-6, s.y-1, 12, 2);
      ctx.fillRect(s.x-1, s.y-6, 2, 12);
    }
  }

  // ghost & player
  const g=state.ghost, p=state.player; const dpg=Math.hypot(p.x-g.x,p.y-g.y);
  ctx.globalAlpha= state.inHunt ? 0.9 : (dpg<120 ? 0.6 : 0.15);
  ctx.fillStyle='#b3c7ff'; ctx.beginPath(); ctx.arc(g.x,g.y,10,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;

  ctx.fillStyle='#8fd1ff'; ctx.beginPath(); ctx.arc(p.x,p.y,10,0,Math.PI*2); ctx.fill();

  // ===== Robust lighting: Dark overlay + cut-out cone + small glow =====
  const hasFlash = state.flashlight && state.battery>0;
  ctx.save();
  // 1) Lay down darkness
  ctx.globalCompositeOperation='source-over';
  ctx.fillStyle = `rgba(0,0,0,${hasFlash?0.82:0.96})`;
  ctx.fillRect(0,0,w,h);

  if(hasFlash){
    // 2) Cut the cone from the darkness (reveals the scene below on THIS canvas)
    const coneRadius = 300;
    const coneHalfAngle = 0.38;
    ctx.globalCompositeOperation='destination-out';
    ctx.translate(p.x,p.y); ctx.rotate(p.angle);
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,coneRadius,-coneHalfAngle,coneHalfAngle); ctx.closePath(); ctx.fill();

    // 3) Add a faint inner glow in the cone to “brighten” perception
    ctx.globalCompositeOperation='lighter';
    const glow = ctx.createRadialGradient(0,0,6, 0,0,120);
    glow.addColorStop(0,'rgba(180,210,255,0.35)');
    glow.addColorStop(1,'rgba(180,210,255,0.00)');
    ctx.fillStyle=glow;
    ctx.beginPath(); ctx.arc(0,0,150,-coneHalfAngle,coneHalfAngle); ctx.lineTo(0,0); ctx.fill();
  }
  ctx.restore();
  // ===== end lighting =====

  // labels
  ctx.fillStyle='#5c84c7'; ctx.font='12px ui-monospace,Menlo,Consolas';
  ctx.fillText('Van Exit', state.map.van.x, state.map.van.y-6);
  ctx.fillText(state.ghostRoom.name+' (colder)', state.ghostRoom.x+6, state.ghostRoom.y+12);

  if(state.gameOver||state.won){
    ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle=state.won?'#86efac':'#ff6b6b'; ctx.font='bold 42px Inter,system-ui'; ctx.textAlign='center';
    ctx.fillText(state.won?'CONTRACT COMPLETE':'YOU DIED', w/2, h/2 - 6);
    ctx.fillStyle='#a7b9dc'; ctx.font='16px Inter,system-ui';
    ctx.fillText('Click "Start New Contract" to play again', w/2, h/2 + 24);
  }
}
})();
</script>
</body>
</html>
